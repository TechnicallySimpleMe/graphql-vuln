---
kind: pipeline
type: exec
name: default

platform:
  os: linux
  arch: amd64

steps:
- name: greeting
  commands:
  - echo hello world
  - echo hello world 2
- name: test docker
  environment:
    PASSWORD:
      from_secret: AQUA_DEMO_PASS
    USERNAME:
      from_secret: AQUA_DEMO_USER
    DH_PASSWORD:
      from_secret: DH_DEMO_PASS
    DH_USERNAME:
      from_secret: DH_DEMO_USER
    AQUA_TOKEN:
      from_secret: AQUA_TOKEN
    AQUA_SERVER:
      from_secret: AQUA_SERVER
    AQUA_REG_USER:
      from_secret: AQUA_REG_USER
    AQUA_REG_PASS:
      from_secret: AQUA_REG_PASS
      
  commands:
  - docker login -u $DH_USERNAME -p $DH_PASSWORD
  - docker build -t graphql-droneci:$DRONE_COMMIT_SHA .
  - docker push saargondocker/graphql-droneci:$DRONE_COMMIT_SHA
  - docker login registry.aquasec.com -u $AQUA_REG_USER -p $AQUA_REG_PASS
  - docker run -d -e SCALOCK_LOG_LEVEL=DEBUG registry.aquasec.com/scanner:2210.13.7 scan --token $AQUA_TOKEN --host $AQUA_SERVER --local saargondocker/graphql-droneci:$DRONE_COMMIT_SHA
  - docker images
